<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³–å°¿ç—…ç”¨è—¥æ±ºç­–æ”¯æ´ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; }
    .container { max-width: 1100px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; }
    .status-bar { text-align: center; background: #e8f6f3; padding: 10px; border-radius: 8px; color: #16a085; margin-bottom: 20px; border: 1px solid #16a085; }
    .patient-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 40px; }
    .patient-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; border-top: 5px solid #3498db; }
    .patient-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .patient-card h3 { margin: 0 0 10px 0; color: #2c3e50; }
    .content { display: none; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; }
    .back-btn { position: absolute; top: 20px; left: 20px; background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; }
    canvas { max-height: 300px; width: 100%; margin: 20px 0; }
    .indicators { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; margin: 30px 0; }
    .indicator-box { text-align: center; min-width: 150px; padding: 15px; background: #f8f9fa; border-radius: 10px; }
    .bar { height: 40px; border-radius: 8px; line-height: 40px; color: white; font-weight: bold; font-size: 1.2em; margin-top: 10px; }
    .green { background: #27ae60; } .yellow { background: #f39c12; } .red { background: #e74c3c; }
    .rec-item { background: #f1f8ff; padding: 15px; border-left: 5px solid #3498db; margin: 10px 0; border-radius: 4px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>ç³–å°¿ç—…ç”¨è—¥æ±ºç­–æ”¯æ´ç³»çµ± (CDS)</h1>
    
    <div id="smartStatus" class="status-bar" style="display:none;"></div>

    <div id="selectorSection">
      <h2 style="color:#34495e;">è«‹é¸æ“‡æ¸¬è©¦å€‹æ¡ˆ (ä¾æ“šç—…äººè³‡è¨Š.docx)</h2>
      <div class="patient-selector" id="patientSelector"></div>
    </div>

    <div class="content" id="patientContent">
      <button class="back-btn" onclick="location.reload()">â† è¿”å›åˆ—è¡¨</button>
      <h2 id="patientHeader" style="text-align:center; color:#2980b9;"></h2>
      
      <div style="display:flex; justify-content: space-around; color:#7f8c8d; margin-bottom:20px;">
        <span id="txtID"></span>
        <span id="txtScenario"></span>
      </div>

      <canvas id="hba1cChart"></canvas>

      <div class="indicators" id="indicators"></div>

      <div class="recommendations">
        <h3>ğŸ’¡ ADA 2025 å€‹äººåŒ–å»ºè­°</h3>
        <div id="recommendationsList"></div>
      </div>
    </div>
  </div>

  <script>
    // === æ ¸å¿ƒè³‡æ–™åº«ï¼šå°æ‡‰ã€Œç—…äººè³‡è¨Š.docxã€===
    const testPatients = [
      { id: "683785", name: "é™³å¿—æ˜", age: 45, gender: "ç”·", scenario: "å¹´è¼•æ–°è¨ºæ–·ï¼Œå¿«é€Ÿæ”¹å–„", target: 7.0, latestHba1c: 7.1, egfr: 90, bmi: 27 },
      { id: "683813", name: "ç‹å°æ˜", age: 62, gender: "ç”·", scenario: "ç³–å°¿ç—…åˆä½µä¸­åº¦è…ç—…è®Š", target: 7.5, latestHba1c: 7.6, egfr: 45, bmi: 26 },
      { id: "683847", name: "æ—é˜¿èŠ±", age: 65, gender: "å¥³", scenario: "é«˜é½¡å¤šå…±ç—…ï¼Œç›®æ¨™æ”¾å¯¬", target: 8.0, latestHba1c: 7.5, egfr: 55, bmi: 22 },
      { id: "683882", name: "å¼µå®¶è±ª", age: 40, gender: "ç”·", scenario: "å¹´è¼•è‚¥èƒ–ï¼Œåå½ˆå¾Œæ˜é¡¯æ”¹å–„", target: 7.0, latestHba1c: 6.1, egfr: 95, bmi: 33 },
      { id: "684487", name: "ææ€¡å›", age: 52, gender: "å¥³", scenario: "æ§åˆ¶è‰¯å¥½ï¼Œå¯è€ƒæ…®æ¸›è—¥", target: 7.0, latestHba1c: 5.8, egfr: 100, bmi: 21 }
    ];

    let myChart = null;

    // å•Ÿå‹•æ™‚åµæ¸¬ SMART Context
    window.onload = function() {
      renderList();
      
      FHIR.oauth2.ready().then(client => {
        const statusDiv = document.getElementById('smartStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `ğŸ§¬ å·²èˆ‡ THAS FHIR Server é€£ç·š (ç•¶å‰ç—…äºº ID: ${client.patient.id})`;
        
        const matched = testPatients.find(p => p.id === client.patient.id);
        if(matched) loadPatient(matched);
      }).catch(err => console.log("å±•ç¤ºæ¨¡å¼ï¼šæœªåµæ¸¬åˆ° EHR å•Ÿå‹•ç’°å¢ƒ"));
    };

    function renderList() {
      const html = testPatients.map(p => `
        <div class="patient-card" onclick='loadPatientById("${p.id}")'>
          <h3>${p.name} (${p.gender}, ${p.age}æ­²)</h3>
          <p><strong>æƒ…å¢ƒï¼š</strong>${p.scenario}</p>
          <p>æœ€æ–° HbA1c: ${p.latestHba1c}% / ç›®æ¨™: ${p.target}%</p>
        </div>
      `).join('');
      document.getElementById('patientSelector').innerHTML = html;
    }

    function loadPatientById(id) {
      const p = testPatients.find(item => item.id === id);
      if(p) loadPatient(p);
    }

    function loadPatient(p) {
      document.getElementById('selectorSection').style.display = 'none';
      document.getElementById('patientContent').style.display = 'block';
      document.getElementById('patientHeader').innerText = `${p.name} è‡¨åºŠè‡¨åºŠæ±ºç­–å„€è¡¨æ¿`;
      document.getElementById('txtID').innerText = `ç—…äºº ID: ${p.id}`;
      document.getElementById('txtScenario').innerText = `è‡¨åºŠæƒ…å¢ƒ: ${p.scenario}`;

      renderChart(p);
      renderIndicators(p);
      renderCDS(p);
    }

    function renderChart(p) {
      const ctx = document.getElementById('hba1cChart').getContext('2d');
      if (myChart) myChart.destroy();
      
      // æ¨¡æ“¬ 24 å€‹æœˆçš„è¶¨å‹¢ (ç”±é«˜å¾€ä½é™)
      const mockTrend = Array.from({length: 24}, (_, i) => (p.latestHba1c + (24-i)*0.1).toFixed(1));
      mockTrend.push(p.latestHba1c);

      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length: 25}, (_, i) => `M-${24-i}`),
          datasets: [{
            label: 'HbA1cè¶¨å‹¢ (%)',
            data: mockTrend,
            borderColor: '#3498db',
            tension: 0.3,
            fill: true,
            backgroundColor: 'rgba(52, 152, 219, 0.1)'
          }, {
            label: 'å€‹äººåŒ–ç›®æ¨™å€¼',
            data: Array(25).fill(p.target),
            borderColor: '#e74c3c',
            borderDash: [5, 5],
            pointRadius: 0
          }]
        }
      });
    }

    function renderIndicators(p) {
      const getHColor = v => v <= p.target ? 'green' : (v <= p.target + 0.5 ? 'yellow' : 'red');
      const getEColor = v => v >= 60 ? 'green' : (v >= 30 ? 'yellow' : 'red');
      const getBColor = v => v < 27 ? 'green' : 'red';

      document.getElementById('indicators').innerHTML = `
        <div class="indicator-box"><div>HbA1c</div><div class="bar ${getHColor(p.latestHba1c)}">${p.latestHba1c}%</div><small>ç›®æ¨™: ${p.target}%</small></div>
        <div class="indicator-box"><div>eGFR</div><div class="bar ${getEColor(p.egfr)}">${p.egfr}</div><small>è…åŠŸèƒ½æŒ‡æ¨™</small></div>
        <div class="indicator-box"><div>BMI</div><div class="bar ${getBColor(p.bmi)}">${p.bmi}</div><small>è‚¥èƒ–è©•ä¼°</small></div>
      `;
    }

    function renderCDS(p) {
      let html = "";
      if (p.latestHba1c > p.target) html += `<div class="rec-item">ğŸ”´ <strong>è¡€ç³–å°šæœªé”æ¨™ï¼š</strong>å»ºè­°åŠ å¼·ç”Ÿæ´»å‹æ…‹èª¿æ•´ï¼Œä¸¦æª¢è¦–æ˜¯å¦éœ€èª¿æ•´ Metformin åŠ‘é‡ã€‚</div>`;
      else html += `<div class="rec-item" style="border-left-color:green;">ğŸŸ¢ <strong>è¡€ç³–æ§åˆ¶é”æ¨™ï¼š</strong>è«‹ç¶­æŒç¾æœ‰æ²»ç™‚è¨ˆç•«ï¼Œå®šæœŸè¿½è¹¤ã€‚</div>`;

      if (p.egfr < 60) html += `<div class="rec-item">ğŸ’Š <strong>å™¨å®˜ä¿è­·å»ºè­°ï¼š</strong>åµæ¸¬åˆ°è…åŠŸèƒ½å—æ (eGFR ${p.egfr})ï¼Œä¾æ“š ADA 2025 æŒ‡å¼•ï¼Œå„ªå…ˆå»ºè­°ä½¿ç”¨ <strong>SGLT2 æŠ‘åˆ¶åŠ‘</strong>ã€‚</div>`;
      
      if (p.bmi >= 27) html += `<div class="rec-item">âš–ï¸ <strong>é«”é‡ç®¡ç†å»ºè­°ï¼š</strong>BMI é” ${p.bmi}ï¼Œå»ºè­°è€ƒæ…®ä½¿ç”¨å…·æ¸›é‡æ•ˆç›Šä¹‹ <strong>GLP-1 RA</strong>ã€‚</div>`;
      
      if (p.latestHba1c < 6.0) html += `<div class="rec-item" style="border-left-color:#f39c12;">âš ï¸ <strong>ä½è¡€ç³–é¢¨éšªï¼š</strong>HbA1c ä½æ–¼ 6.0%ï¼Œè‹¥æœ‰ä½¿ç”¨è—¥ç‰©è«‹è©•ä¼°æ¸›è—¥å¯èƒ½æ€§ã€‚</div>`;

      document.getElementById('recommendationsList').innerHTML = html;
    }
  </script>
</body>
</html>